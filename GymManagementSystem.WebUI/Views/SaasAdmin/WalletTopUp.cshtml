@model GymManagementSystem.WebUI.Models.WalletTopUpViewModel
@{
    ViewData["Title"] = "Wallet Management";
}

<div class="row">
    <div class="col-lg-3">
        <partial name="_SaasSidebar" />
    </div>
    <div class="col-lg-9">
        <h3 class="mb-3"><i class="fas fa-wallet me-2"></i>Wallet Management</h3>

        <div class="card shadow-sm">
            <div class="card-header">Admin Cash Top-Up</div>
            <div class="card-body">
                <form asp-action="WalletTopUp" method="post" class="row g-3">
                    @Html.AntiForgeryToken()
                    <div class="col-md-6">
                        <label class="form-label">Search Member</label>
                        <input id="memberSearch" class="form-control" type="text" placeholder="Type member name/code..." />
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Member</label>
                        <select id="memberSelect" class="form-select" name="MemberId" required>
                            <option value="">Select member</option>
                            @foreach (var m in Model.Members)
                            {
                                <option value="@m.Id" selected="@(Model.MemberId == m.Id ? "selected" : null)">@m.Display</option>
                            }
                        </select>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Current Wallet Balance</label>
                        <div class="alert alert-info mb-0">
                            <strong id="currentBalance">-</strong>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <label class="form-label">Top-Up Amount</label>
                        <input class="form-control" type="number" step="0.01" min="0.01" name="Amount" required />
                    </div>

                    <div class="col-12">
                        <label class="form-label">Notes (Optional)</label>
                        <textarea class="form-control" name="Notes" rows="3" placeholder="Reason, receipt ref, internal note..."></textarea>
                    </div>

                    <div class="col-12">
                        <button class="btn btn-primary">Top Up Wallet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const memberSelect = document.getElementById("memberSelect");
            const memberSearch = document.getElementById("memberSearch");
            const currentBalance = document.getElementById("currentBalance");
            const balances = {
@foreach (var kv in Model.WalletBalancesByMemberId)
{
@:                "@kv.Key": @kv.Value.ToString(System.Globalization.CultureInfo.InvariantCulture),
}
            };

            function updateBalance() {
                const memberId = memberSelect?.value;
                if (!memberId) {
                    currentBalance.textContent = "-";
                    return;
                }
                const balance = balances[memberId] ?? 0;
                currentBalance.textContent = Number(balance).toFixed(2);
            }

            function filterMembers() {
                const q = (memberSearch?.value || "").toLowerCase();
                if (!memberSelect) return;
                for (const opt of memberSelect.options) {
                    if (!opt.value) continue;
                    const show = opt.text.toLowerCase().includes(q);
                    opt.hidden = !show;
                }
            }

            memberSelect?.addEventListener("change", updateBalance);
            memberSearch?.addEventListener("input", filterMembers);
            updateBalance();
        })();
    </script>
}
